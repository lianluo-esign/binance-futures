# 横向柱状图长度限制功能更新

## 更新概述

根据用户需求，为时间维度足迹图表的横向成交量柱状图添加了长度限制功能，确保柱状图最大不超过横向网格的指定格数。

## 新增功能

### 1. 柱状图长度限制
- **默认限制**: 最大5个网格单位
- **可调范围**: 1-10个网格单位
- **精度控制**: 0.5个网格单位的调整步长
- **实时生效**: 调整后立即应用到图表显示

### 2. 智能长度计算
- **比例缩放**: 根据成交量比例计算柱状图长度
- **硬性限制**: 确保任何情况下都不超过设定的最大长度
- **统一标准**: 买单和卖单使用相同的长度限制规则

## 技术实现

### 1. 数据结构更新

#### TimeFootprintChart 结构体
```rust
pub struct TimeFootprintChart {
    // ... 其他字段
    /// 最大柱状图长度（网格单位）- 限制为5格
    max_bar_length_grids: f64,
    // ... 其他字段
}
```

#### 默认配置
```rust
impl Default for TimeFootprintChart {
    fn default() -> Self {
        Self {
            // ... 其他配置
            max_bar_length_grids: 5.0, // 默认最大5个网格单位
            // ... 其他配置
        }
    }
}
```

### 2. 长度计算逻辑

#### 买单柱状图长度计算
```rust
// 计算柱状图长度，限制最大为指定网格单位
let normalized_length = point.buy_volume / max_volume; // 0.0 到 1.0
let bar_length = (normalized_length * self.max_bar_length_grids).min(self.max_bar_length_grids);
```

#### 卖单柱状图长度计算
```rust
// 计算柱状图长度，限制最大为指定网格单位
let normalized_length = point.sell_volume / max_volume; // 0.0 到 1.0
let bar_length = (normalized_length * self.max_bar_length_grids).min(self.max_bar_length_grids);
```

### 3. 用户界面控制

#### 控制面板新增滑块
```rust
ui.label("最大柱长:");
ui.add(egui::Slider::new(&mut self.max_bar_length_grids, 1.0..=10.0)
    .suffix(" 格")
    .step_by(0.5));
```

## 功能特性

### 1. 长度限制规则
- **最小值**: 1个网格单位
- **最大值**: 10个网格单位
- **默认值**: 5个网格单位
- **调整步长**: 0.5个网格单位

### 2. 视觉效果
- **一致性**: 所有柱状图遵循相同的长度限制
- **比例性**: 在限制范围内保持成交量比例关系
- **清晰度**: 避免过长柱状图影响图表可读性

### 3. 实时调整
- **即时生效**: 滑块调整后立即更新图表显示
- **动态缩放**: 根据新的限制重新计算所有柱状图长度
- **保持比例**: 调整限制时保持各柱状图之间的相对比例

## 使用说明

### 1. 默认行为
- 程序启动时，柱状图最大长度默认为5个网格单位
- 所有买单和卖单柱状图都遵循此限制

### 2. 手动调整
1. 在时间维度图表下方找到控制面板
2. 定位到"最大柱长"滑块控制
3. 拖动滑块调整最大长度（1-10格）
4. 图表会实时更新显示效果

### 3. 最佳实践
- **密集数据**: 建议使用较小的限制值（2-3格）
- **稀疏数据**: 可以使用较大的限制值（6-8格）
- **标准显示**: 默认的5格设置适合大多数情况

## 技术优势

### 1. 性能优化
- **计算效率**: 简单的数学运算，不影响渲染性能
- **内存友好**: 不增加额外的内存开销
- **实时响应**: 调整后立即生效，无需重新加载数据

### 2. 用户体验
- **直观控制**: 滑块界面简单易用
- **即时反馈**: 调整后立即看到效果
- **灵活配置**: 可根据个人喜好和数据特点调整

### 3. 兼容性
- **向后兼容**: 不影响现有功能
- **数据完整**: 不改变原始数据，只影响显示效果
- **配置保持**: 调整的设置在会话期间保持有效

## 配置选项

### 当前可配置参数
- `max_bar_length_grids`: 最大柱状图长度（1.0-10.0格）
- `step_by`: 调整步长（0.5格）

### 未来扩展可能
- 保存用户偏好设置到配置文件
- 支持不同时间框架的独立长度设置
- 添加预设的长度配置方案

## 注意事项

### 1. 数据解读
- 柱状图长度受限制影响，不能直接反映绝对成交量大小
- 需要结合数值显示来了解具体的成交量数据
- 相对比例关系在限制范围内仍然有效

### 2. 视觉效果
- 较小的限制值可能使小成交量的柱状图难以识别
- 较大的限制值可能导致图表显示过于拥挤
- 建议根据实际数据密度调整合适的限制值

### 3. 性能考虑
- 频繁调整限制值会触发图表重绘
- 建议在找到合适设置后保持稳定
- 大量数据情况下，较小的限制值有助于提升渲染性能

## 故障排除

### 常见问题
1. **柱状图显示异常**: 检查最大长度设置是否合理
2. **调整无效果**: 确认有足够的交易数据用于显示
3. **性能问题**: 尝试减小最大长度限制值

### 解决方案
- 重置为默认值（5格）通常能解决大部分显示问题
- 确保网络连接稳定以获取实时数据
- 如有持续问题，重启程序可恢复默认设置
