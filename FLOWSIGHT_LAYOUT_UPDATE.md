# FlowSight 布局更新 - 时间维度足迹图表

## 更新概述

本次更新实现了用户要求的左右分割布局，将原有的统一订单簿界面改为：
- **左侧 70%**: 订单簿表格区域
- **右侧 30%**: 新增的时间维度足迹图表

## 新增功能

### 1. 时间维度足迹图表
- **位置**: 界面右侧 30% 区域
- **图表类型**: 基于 egui_plot 的水平柱状图
- **实时更新**: 与订单簿数据同步，维持 1ms 刷新频率

### 2. 数据聚合规则

#### 时间维度聚合
- **聚合单位**: 按分钟聚合（从第0秒到第59秒）
- **滑动窗口**: 显示最近 20-30 分钟的数据
- **实时更新**: 当前分钟内的数据实时累积更新

#### 价格聚合
- **精度**: 1美元精度
- **聚合方式**: 使用向上取整（ceil）方式
- **层级管理**: 每个1美元价格层级独立聚合买卖单量

### 3. 可视化实现

#### 水平柱状图设计
- **X轴**: 时间轴（分钟级别）
- **Y轴**: 价格轴（1美元精度的价格层级）
- **买单可视化**: 半透明绿色柱状图，从价格-时间交叉点向右水平延伸
- **卖单可视化**: 半透明红色柱状图，从价格-时间交叉点向左水平延伸
- **柱状图长度**: 与对应的买/卖单累计量成正比，最大限制为相邻X轴时间点距离的1/2

#### 数值显示
- **成交量数值**: 在柱状图上显示具体的成交量数值
- **颜色方案**: 
  - 买单: 半透明绿色 (120, 255, 120, 180)
  - 卖单: 半透明红色 (255, 120, 120, 180)

### 4. 参考线功能
- **当前价格线**: 黄色实线，横跨整个时间范围
- **最优买价线**: 绿色虚线
- **最优卖价线**: 红色虚线

## 技术实现

### 1. 新增依赖
```toml
egui_plot = "0.27"
chrono = { version = "0.4", features = ["serde"] }
```

### 2. 核心组件

#### TimeFootprintData
- 分钟级数据聚合管理器
- 支持滑动窗口和实时更新
- 价格层级聚合（1美元精度）

#### TimeFootprintChart
- 基于 egui_plot 的图表渲染组件
- 水平柱状图可视化
- 交互式缩放和平移
- 固定轴刻度间距和专业格式化

#### 数据流集成
- 在 OrderBookManager 中集成时间维度数据收集
- 每笔交易自动更新时间维度足迹数据
- 实时同步订单簿和图表数据

### 3. 布局调整

#### 统一订单簿组件更新
- 从全屏布局改为左侧 70% 布局
- 保持原有的订单簿表格功能
- 新增右侧 30% 图表区域

#### 响应式设计
- 自动适配窗口大小变化
- 保持 70:30 的固定比例
- 维持 5% 标题 + 95% 内容的垂直布局

## 使用说明

### 1. 启动程序
```bash
cargo run
```

### 2. 界面布局
- **左侧**: 传统的订单簿表格，显示买卖深度、主动交易量等
- **右侧**: 时间维度足迹图表，显示历史交易分布

### 3. 图表交互
- **缩放**: 鼠标滚轮缩放
- **平移**: 鼠标拖拽平移
- **时间窗口**: 可调整显示的分钟数（10-60分钟）
- **自动跟随**: 可选择是否自动跟随最新数据
- **柱状图长度**: 自动限制为X轴间距的1/2，无需手动调整

### 4. 数据解读
- **绿色柱状图**: 主动买单量，向右延伸
- **红色柱状图**: 主动卖单量，向左延伸
- **柱状图长度**: 反映成交量大小，最大为X轴间距的1/2
- **价格分布**: 垂直方向显示不同价格层级的交易活动
- **时间轴**: 显示为HH:MM格式，固定1分钟间距
- **价格轴**: 显示为整数价格，固定5美元间距

## 性能优化

### 1. 数据缓存
- 缓存图表数据，避免重复计算
- 版本控制机制，仅在数据变化时更新

### 2. 滑动窗口
- 自动清理过期数据
- 维持固定的内存使用量

### 3. 渲染优化
- 100ms 更新间隔的图表缓存
- 按需渲染，避免不必要的重绘

## 配置选项

### 时间维度图表配置
- `display_window_minutes`: 显示窗口大小（默认25分钟）
- `auto_follow`: 自动跟随最新数据（默认开启）
- `buy_color`: 买单颜色（半透明绿色）
- `sell_color`: 卖单颜色（半透明红色）
- 柱状图最大长度：自动设置为X轴间距的1/2（固定值）
- 价格刻度间距：固定5美元间距，提升可读性

### 数据聚合配置
- `window_size_minutes`: 滑动窗口大小（默认30分钟）
- 价格聚合精度：1美元（固定）
- 时间聚合精度：1分钟（固定）

## 兼容性

- 保持与现有订单簿功能的完全兼容
- 不影响原有的实时数据处理逻辑
- 新增功能为可选显示，不影响性能

## 未来扩展

### 可能的增强功能
1. **多时间框架**: 支持秒级、5分钟、15分钟等不同时间聚合
2. **更多指标**: 添加成交量加权平均价格（VWAP）等指标线
3. **热力图模式**: 使用颜色深度表示成交量密度
4. **导出功能**: 支持图表数据导出和截图保存
5. **自定义配色**: 用户可自定义买卖单颜色方案

### 技术优化方向
1. **GPU加速**: 使用GPU渲染提升大数据量下的性能
2. **数据压缩**: 历史数据压缩存储
3. **多线程**: 数据聚合和渲染分离到不同线程
