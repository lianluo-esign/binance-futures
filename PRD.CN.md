# 产品需求文档 (PRD)
## 币安期货交易应用 - FlowSight

### 1. 产品愿景与目标

**产品名称：** FlowSight  
**版本：** 0.1.0  
**目标市场：** 专业加密货币交易员和量化分析师  

#### 愿景声明
FlowSight 是一个高性能、实时的币安期货交易订单流分析系统，旨在通过直观的桌面GUI界面为交易员提供全面的市场深度可视化和交易执行洞察。

#### 主要目标
- 提供亚毫秒级延迟的实时订单簿可视化
- 提供包含历史足迹数据的全面订单流分析
- 通过先进的市场微观结构分析帮助专业交易员做出明智决策
- 维持系统稳定性和可靠性，支持连续24/7运行

### 2. 当前功能

#### 2.1 核心交易界面
- **实时订单簿显示**：围绕当前市场价格显示±40个价格级别的实时BTCUSDT订单簿
- **统一数据可视化**：在单一综合表格中合并订单簿深度和交易足迹数据
- **价格级别聚合**：使用向下取整的1美元价格级别聚合，提供更清晰的流动性显示
- **自动跟踪价格移动**：同步滚动，自动以当前价格移动为中心

#### 2.2 GUI框架（基于egui）
- **原生桌面应用**：使用egui框架构建，提供响应式、高性能GUI
- **全窗口布局**：响应式设计，占用全窗口高度和宽度（默认1200x800）
- **深色主题界面**：专业深色背景，为长时间交易会话优化色彩方案
- **实时更新**：1毫秒刷新间隔，实现超低延迟数据可视化

#### 2.3 数据可视化功能
- **成交量条形图**：订单数量后的水平条形图，按比例缩放
- **颜色编码订单**：买单使用蓝色，卖单使用深红色（非标准色彩方案偏好）
- **主动成交量高亮**：主动买单量（主动买单量）使用绿色，加粗格式
- **历史数据集成**：5秒累积交易数据与历史足迹分析

#### 2.4 技术性能
- **高频数据处理**：支持高频市场数据的事件驱动架构
- **WebSocket集成**：实时币安期货API连接，具有自动重连功能
- **内存优化**：无锁环形缓冲区实现，实现最佳性能
- **CPU亲和性支持**：专用处理能力的核心亲和性设置

### 3. 用户需求

#### 3.1 视觉设计需求
- **色彩方案**：买单使用蓝色，卖单使用深红色，主动买单量使用绿色
- **排版**：主动买卖订单成交量数字使用粗体格式
- **布局结构**：5%标题/95%表格比例，固定表格标题
- **无斑马条纹**：清洁的表格设计，无交替行颜色
- **品牌标识**：在src/image/logo.png集成产品logo，支持窗口和任务栏图标

#### 3.2 数据显示需求
- **价格级别**：围绕当前价格精确显示±40个价格级别，动态填充
- **空级别处理**：市场数据稀疏时的零成交量占位符
- **列结构**：
  1. 主动卖单（5秒累积）
  2. 买单深度
  3. 价格（中心列）
  4. 卖单深度
  5. 主动买单（5秒累积）
  6. 历史累积买单
  7. 历史累积卖单
  8. 订单差值
  9. 总成交量

#### 3.3 性能需求
- **更新频率**：数据处理和UI渲染均为1毫秒刷新间隔
- **数据清理**：基于最佳价格自动移除无效买卖订单
- **延迟**：使用无锁架构实现亚毫秒级事件处理
- **稳定性**：24/7运行能力，具有自动错误恢复

### 4. 功能需求

#### 4.1 实时数据处理
- **WebSocket流**：
  - `{symbol}@depth20@100ms` - 订单簿深度更新
  - `{symbol}@trade` - 个别交易数据
  - `{symbol}@bookTicker` - 最佳买卖价ticker更新
- **事件处理**：具有环形缓冲区优化的无锁事件总线架构
- **数据聚合**：实时价格级别聚合和成交量汇总

#### 4.2 订单簿管理
- **价格级别跟踪**：动态价格级别管理，自动居中
- **成交量计算**：实时买卖成交量计算，历史跟踪
- **市场状态**：当前价格跟踪，最佳买卖价监控
- **数据验证**：自动过滤无效或过期订单数据

#### 4.3 用户界面控制
- **自动跟踪切换**：启用/禁用自动价格跟随
- **手动滚动**：禁用自动跟踪时的用户控制表格导航
- **连接状态**：实时WebSocket连接状态指示器
- **性能指标**：标题栏中显示每秒事件数

### 5. 非功能性需求

#### 5.1 性能规格
- **延迟**：< 1毫秒事件处理时间
- **吞吐量**：支持每秒10,000+事件
- **内存使用**：通过环形缓冲区回收实现高效内存管理
- **CPU利用率**：针对单核性能优化，具有CPU亲和性

#### 5.2 可靠性需求
- **正常运行时间**：99.9%可用性目标
- **错误恢复**：具有指数退避的自动WebSocket重连
- **数据完整性**：保证事件顺序和数据一致性
- **优雅降级**：在临时网络问题期间继续运行

#### 5.3 可用性需求
- **响应时间**：即时UI反馈（60fps < 16毫秒）
- **视觉清晰度**：长时间使用的高对比度颜色
- **信息密度**：最大数据可见性，无杂乱
- **专业外观**：适合交易大厅的清洁、现代界面

### 6. 技术约束

#### 6.1 平台需求
- **操作系统**：Windows（主要），具有跨平台Rust兼容性
- **架构**：x86_64，可选CPU特定优化
- **依赖项**：为安全性和性能最小化外部依赖
- **网络**：WebSocket数据源的稳定互联网连接

#### 6.2 集成需求
- **币安API**：期货WebSocket API合规性
- **数据格式**：JSON消息解析和验证
- **时间同步**：全球市场的UTC时间戳处理
- **日志记录**：基于文件的日志系统（无控制台输出以避免UI干扰）

### 7. 成功指标和验收标准

#### 7.1 性能指标
- **延迟**：99百分位事件处理 < 1毫秒
- **吞吐量**：持续5,000+事件/秒处理
- **UI响应性**：一致的60fps渲染
- **内存效率**：正常运行下 < 100MB RAM使用

#### 7.2 功能验收
- **数据准确性**：100%订单簿数据完整性
- **视觉正确性**：正确的颜色编码和格式
- **自动跟踪**：平滑的价格跟随，无延迟
- **连接稳定性**：< 0.1% WebSocket断开率

#### 7.3 用户体验指标
- **启动时间**：应用启动 < 3秒
- **视觉清晰度**：在交易环境照明下所有文本可读
- **信息可访问性**：所有关键数据无需滚动即可见
- **专业标准**：适合机构交易使用的界面

### 8. 未来增强功能（超出范围）

- 超越BTCUSDT的多符号支持
- 历史数据回放功能
- 高级图表和技术指标
- 订单执行能力
- 投资组合管理功能
- 多交易所连接

### 9. 风险考虑

- **市场数据依赖**：依赖币安API可用性
- **性能下降**：高波动期间的潜在问题
- **内存泄漏**：长时间运行应用的稳定性问题
- **网络延迟**：与币安服务器地理距离的影响

---

**文档版本：** 1.0  
**最后更新：** 2025-06-23  
**下次审查：** 季度或重大功能添加时
