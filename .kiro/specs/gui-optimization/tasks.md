# GUI优化实施计划

- [x] 1. 创建新的GUI模块结构


  - 创建 `src/gui/orderbook_renderer.rs` 模块，实现订单薄渲染的核心逻辑
  - 创建 `src/gui/bar_chart.rs` 模块，实现横向条形图渲染组件
  - 创建 `src/gui/price_tracker.rs` 模块，实现价格跟踪和居中逻辑
  - 创建 `src/gui/layout_manager.rs` 模块，实现布局管理功能
  - 更新 `src/gui/mod.rs` 导出新模块
  - _需求: 5.1, 5.2, 5.3_

- [x] 2. 实现横向条形图渲染组件


  - [x] 2.1 创建 BarChartRenderer 结构体和基础方法


    - 定义 BarChartRenderer 结构体，包含最大条形图宽度、颜色配置等属性
    - 实现 `new()` 构造函数和基础配置方法
    - 实现 `calculate_bar_length()` 方法，根据数量和最大值计算条形图长度
    - _需求: 4.3, 4.4_

  - [x] 2.2 实现bid和ask条形图渲染方法

    - 实现 `render_bid_bar()` 方法，生成绿色bid条形图字符串
    - 实现 `render_ask_bar()` 方法，生成红色ask条形图字符串
    - 实现 `create_bar_with_text()` 方法，在条形图上叠加数量文本
    - 添加单元测试验证条形图渲染的正确性
    - _需求: 4.1, 4.2, 4.4_

- [x] 3. 实现价格跟踪和智能居中功能


  - [x] 3.1 创建 PriceTracker 组件

    - 定义 PriceTracker 结构体，包含跟踪状态和配置参数
    - 实现 `should_recenter()` 方法，判断是否需要重新居中
    - 实现 `find_price_index()` 辅助方法，在价格列表中查找指定价格的索引
    - _需求: 2.2, 2.5_

  - [x] 3.2 实现智能居中计算逻辑

    - 实现 `calculate_center_offset()` 方法，计算使best bid price居中的滚动偏移
    - 实现 `update_tracking()` 方法，更新价格跟踪状态
    - 添加价格变化阈值检测，避免频繁的微小调整
    - 编写单元测试验证居中计算的准确性
    - _需求: 2.1, 2.2_

- [x] 4. 实现合并的Bid & Ask列显示


  - [x] 4.1 创建 LayoutManager 组件

    - 定义 LayoutManager 结构体，管理列宽和布局配置
    - 实现 `get_column_constraints()` 方法，返回新的列约束配置
    - 实现 `create_header_row()` 方法，创建包含"Bid & Ask"列的表头
    - _需求: 3.1_

  - [x] 4.2 实现合并列数据格式化

    - 实现 `format_merged_bid_ask_cell()` 方法，根据价格位置决定显示bid或ask数据
    - 集成条形图渲染，在合并列中显示横向条形图
    - 实现价格区间判断逻辑，正确区分bid和ask显示区域
    - 添加空白区域处理，在best bid和best ask之间显示分隔符
    - _需求: 3.2, 3.3, 3.4, 4.1, 4.2_

- [x] 5. 重构主渲染函数


  - [x] 5.1 创建 OrderBookRenderer 主组件

    - 定义 OrderBookRenderer 结构体，整合所有子组件
    - 实现构造函数，初始化条形图渲染器、价格跟踪器和布局管理器
    - 实现 `render()` 主方法，协调各组件完成订单薄渲染
    - _需求: 5.1, 5.2_

  - [x] 5.2 实现数据准备和处理逻辑


    - 创建 `OrderBookRenderData` 结构体，封装渲染所需的数据
    - 实现数据转换方法，将 OrderFlow 数据转换为渲染数据
    - 实现最大音量计算，用于条形图归一化
    - 实现可见范围计算，优化渲染性能
    - _需求: 4.3, 6.4_

- [x] 6. 移除价格层级高亮显示


  - [x] 6.1 修改价格单元格渲染逻辑


    - 移除 `src/main.rs` 中的静态价格高亮代码
    - 保留交易价格的短暂高亮功能（3秒）
    - 确保价格文本使用统一的白色前景色
    - 验证移除高亮后的视觉效果
    - _需求: 1.1, 1.2, 1.3_

- [x] 7. 集成新组件到主应用


  - [x] 7.1 更新 ReactiveApp 集成


    - 修改 `src/main.rs` 中的 `render_orderbook()` 函数调用
    - 集成 PriceTracker 到 ReactiveApp 的滚动管理逻辑
    - 更新自动居中相关的方法调用
    - _需求: 2.3, 2.4_

  - [x] 7.2 更新用户交互处理

    - 修改键盘事件处理，支持重新启用自动居中功能
    - 实现手动滚动时暂时禁用自动居中的逻辑
    - 添加快捷键支持，允许用户手动触发居中
    - _需求: 2.3, 2.4_

- [x] 8. 代码文件拆分和重构




  - [x] 8.1 拆分 main.rs 文件





    - 将 `render_orderbook()` 函数移动到新的 GUI 模块
    - 将订单薄相关的辅助函数移动到对应模块
    - 保持 main.rs 文件在500行以内，仅包含主函数和基本设置

    - _需求: 5.1, 5.2_

  - [ ] 8.2 拆分 reactive_app.rs 文件
    - 创建 `src/app/scroll_manager.rs`，移动滚动和居中相关逻辑
    - 创建 `src/app/ui_state.rs`，管理UI状态

    - 确保每个文件都在1000行以内

    - 更新模块导入和依赖关系
    - _需求: 5.1, 5.2, 5.3_

- [ ] 9. 性能优化实现
  - [ ] 9.1 实现渲染性能优化
    - 实现视口裁剪，只渲染可见区域的价格层级

    - 添加条形图计算结果缓存，避免重复计算
    - 实现增量渲染，只更新变化的数据
    - 进行性能测试，确保60FPS渲染性能
    - _需求: 6.1, 6.2_



  - [ ] 9.2 实现平滑滚动动画
    - 实现滚动插值算法，避免跳跃式移动
    - 添加滚动防抖动机制，减少频繁的小幅调整
    - 优化居中触发条件，避免不必要的滚动
    - _需求: 6.3_



- [ ] 10. 错误处理和健壮性
  - [ ] 10.1 实现错误处理机制
    - 定义 GuiError 错误类型，涵盖各种渲染错误情况
    - 实现错误恢复策略，在出错时使用默认布局
    - 添加数据验证，处理异常的价格和音量数据
    - 实现日志记录，便于调试和监控

    - _需求: 6.1_

- [ ] 11. 测试实现
  - [ ] 11.1 编写单元测试
    - 为 BarChartRenderer 编写测试，验证条形图计算和渲染


    - 为 PriceTracker 编写测试，验证居中计算逻辑

    - 为 LayoutManager 编写测试，验证布局和格式化功能
    - 确保测试覆盖率达到80%以上
    - _需求: 4.3, 2.1, 3.2_

  - [ ] 11.2 编写集成测试
    - 测试完整的渲染流程，从数据获取到最终显示
    - 测试用户交互功能，包括手动滚动和自动居中切换
    - 测试高频数据更新下的性能表现
    - 测试不同窗口大小下的布局适应性
    - _需求: 6.1, 2.3, 2.4_

- [ ] 12. 文档和配置更新
  - [ ] 12.1 更新配置和文档
    - 更新 README.md，说明新的GUI功能和快捷键
    - 添加配置选项，允许用户自定义条形图颜色和居中阈值
    - 更新代码注释和文档字符串
    - 创建用户使用指南
    - _需求: 所有需求的文档化_