# ΔTick Pressure 功能文档

## 功能概述

ΔTick Pressure是一个新增的交易信号检测模块，用于识别连续K笔成交量方向一致且价位递增/递减的市场行为，帮助交易者识别"点火检测"和"短冲量跟随"信号。

## 功能特性

### 1. 信号检测逻辑
- **连续性检测**: 检测连续K笔交易的成交量方向一致性
- **价格趋势检测**: 检测价格是否呈现递增或递减趋势
- **信号分类**: 
  - **点火检测**: 总成交量≥10.0且价格变化≥0.05%的强信号
  - **短冲量跟随**: 其他符合条件的弱信号

### 2. 可配置参数
- **K值设置**: 连续交易笔数，默认5笔，可调整范围3-15笔
- **信号窗口容量**: 默认512条信号记录，采用滑动窗口机制

### 3. UI显示特性
- **实时信号流**: 最新信号显示在窗口顶部
- **颜色编码**: 
  - 🔴 红色: 点火检测信号
  - 🔵 蓝色: 短冲量跟随信号
- **详细信息**: 显示时间、信号类型、方向、价格变化、总成交量等

## 技术实现

### 1. 统一数据结构

#### TickData（统一核心数据结构）
```rust
pub struct TickData {
    pub timestamp: u64,
    pub price: f64,
    pub volume: f64,
    pub is_buy: bool,
}
```

**重要**: 这个数据结构同时服务于两个模块：
- **ΔTick Pressure**: 检测连续K笔同方向交易
- **Trade Imbalance**: 计算最近10笔交易的买卖不平衡

#### TickPressureSignal
```rust
pub struct TickPressureSignal {
    pub timestamp: u64,
    pub signal_type: String,
    pub direction: String,
    pub tick_count: usize,
    pub price_start: f64,
    pub price_end: f64,
    pub volume_total: f64,
}
```

### 2. 统一检测算法

#### 数据流处理
1. **统一数据收集**: 每笔交易数据存储到`tick_pressure_window`滑动窗口
2. **双模块计算**: 每次新增交易数据时同时更新两个模块
3. **窗口管理**: 动态调整窗口大小以满足两个模块的需求

#### ΔTick Pressure检测
1. **方向一致性检查**: 验证最近K笔交易的买卖方向是否一致
2. **价格趋势检查**: 验证价格是否呈现单调递增或递减
3. **信号生成**: 根据成交量和价格变化幅度分类信号
4. **信号存储**: 将信号文本存储到容量为512的滑动窗口

#### Trade Imbalance计算
1. **最近10笔**: 从滑动窗口中取最近10笔交易
2. **买卖统计**: 统计买单和卖单数量
3. **不平衡计算**: TI = (买单数 - 卖单数) / 总交易数
4. **实时更新**: 每笔新交易都会重新计算TI值

### 3. UI集成

#### Trade Imbalance模块
- **位置**: 价格图表下方
- **高度**: 固定100像素
- **显示**: 基于最近10笔交易的TI值和买卖比例
- **更新**: 实时更新，无时间延迟

#### ΔTick Pressure模块
- **位置**: Trade Imbalance指标下方
- **高度**: 占满剩余空间
- **布局**: 垂直滚动列表，最新信号在顶部
- **控制**: K值调节滑块（3-15笔）

## 使用方法

### 1. 查看信号
- 信号会实时显示在ΔTick Pressure面板中
- 最新信号显示在列表顶部
- 不同类型信号用不同颜色区分

### 2. 调整参数
- 使用K值滑块调整连续交易笔数
- 较小的K值更敏感，较大的K值更稳定

### 3. 信号解读
- **点火检测**: 强烈的市场动能信号，通常预示较大的价格移动
- **短冲量跟随**: 较弱的跟随信号，可用于确认趋势

## 信号格式示例

```
[14:23:45.123] 点火检测 - 买单 上涨 连续5笔 价格67890.50->67895.20 总量15.3456
[14:23:44.856] 动量跟随 - 卖单 下跌 连续5笔 价格67895.20->67890.50 总量8.7234
```

**注意**: 总量显示精度已提高到4位小数，以更准确显示小额交易量。

## 性能优化

1. **滑动窗口**: 限制内存使用，自动清理过期数据
2. **批量处理**: 避免频繁的UI更新
3. **缓存机制**: 减少重复计算

## 注意事项

1. **延迟**: 信号检测需要等待K笔交易完成
2. **噪音**: 在低流动性市场可能产生较多噪音信号
3. **参数调优**: 建议根据不同市场条件调整K值

## 音频提醒功能

### 1. 音频播放
- **买单冲击**: 播放 `src/audio/buy.mp3`
- **卖单冲击**: 播放 `src/audio/sell.mp3`
- **异步播放**: 不阻塞主线程
- **自动检测**: 根据信号类型自动选择音效

### 2. 音频文件要求
- **格式支持**: MP3, WAV, FLAC, OGG
- **建议时长**: 1-3秒
- **音效特征**:
  - 买单音效: 清脆、上升音调、积极感
  - 卖单音效: 沉稳、下降音调、警示感

### 3. 音频配置
- 音频文件路径相对于项目根目录
- 如果音频文件不存在，程序继续运行但不播放声音
- 可通过修改 `src/audio/player.rs` 自定义音频路径

## 架构优化

### 1. 统一数据源
- **合并前**: Trade Imbalance和ΔTick Pressure使用独立的数据结构
- **合并后**: 两个模块共享`tick_pressure_window`统一数据源
- **优势**: 减少内存使用，提高数据一致性，简化维护

### 2. 计算方式改进
- **Trade Imbalance**: 从基于时间窗口(500ms)改为基于交易笔数(最近10笔)
- **优势**: 更稳定的计算结果，不受市场活跃度影响
- **响应性**: 每笔交易都会立即更新TI值

### 3. 性能优化
```rust
// 统一的数据更新流程
fn update_tick_pressure_detection() {
    // 1. 添加新交易数据
    // 2. 更新Trade Imbalance (最近10笔)
    // 3. 检测ΔTick Pressure信号 (连续K笔)
    // 4. 播放音效 (如果有信号)
}
```

## 未来扩展

1. **信号过滤**: 添加更多过滤条件减少噪音
2. **历史回测**: 支持历史信号回测功能
3. **音量控制**: 添加音量调节功能
4. **信号统计**: 信号成功率统计分析
5. **自定义音效**: 支持用户自定义音效文件
6. **参数优化**: 支持动态调整10笔和K笔参数
