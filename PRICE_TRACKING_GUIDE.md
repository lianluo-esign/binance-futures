# 价格跟踪功能使用指南

## 功能概述

新增的价格跟踪功能让UI界面能够主动跟随当前tick trade price，确保当前交易价格始终显示在窗口的中间位置。

## 核心特性

### 1. 自动价格跟踪
- **功能**: 自动检测当前交易价格变化，当价格变化超过阈值时自动重新居中窗口
- **阈值**: 默认0.1美元，可配置
- **触发条件**: 当前交易价格与上次跟踪价格的差值超过阈值

### 2. 主动窗口居中
- **功能**: 通过主动触发上下按键滑动逻辑，让窗口跟随当前价格
- **实现**: 计算目标价格在价格列表中的位置，自动调整滚动偏移
- **效果**: 当前交易价格始终保持在可视窗口的中心位置

### 3. 手动控制
- **按键控制**: 提供多个按键来控制价格跟踪行为
- **即时响应**: 按键操作立即生效，无延迟

## 按键控制

| 按键 | 功能 | 说明 |
|------|------|------|
| `t` | 切换价格跟踪 | 开启/关闭自动价格跟踪功能 |
| `r` | 手动重新居中 | 立即将窗口居中到当前交易价格 |
| `c` | 切换自动居中 | 开启/关闭基于最优买卖价的自动居中 |
| `空格` | 切换自动滚动 | 开启/关闭自动滚动模式 |
| `↑` | 向上滚动 | 手动向上滚动一行，禁用自动功能 |
| `↓` | 向下滚动 | 手动向下滚动一行，禁用自动功能 |
| `Home` | 回到顶部 | 滚动到价格列表顶部，禁用自动功能 |
| `End` | 启用自动滚动 | 重新启用自动滚动和自动居中 |

## 状态显示

在标题栏中显示当前状态：
```
Binance Futures Order Book - BTCUSDT | 缓冲区: 0/16383 | 事件/秒: 5.2 | 状态: 已连接 | 价格跟踪: 跟踪 | 自动居中: 居中
```

- **价格跟踪**: 显示"跟踪"或"关闭"
- **自动居中**: 显示"居中"或"关闭"

## 工作原理

### 1. 价格变化检测
```rust
// 检查价格是否发生了显著变化
let should_recenter = match self.last_tracked_price {
    Some(last_price) => {
        let price_change = (current_price - last_price).abs();
        price_change >= self.price_change_threshold  // 默认0.1美元
    }
    None => true, // 第一次设置价格
};
```

### 2. 窗口居中计算
```rust
// 计算新的滚动偏移，使目标价格居中
let target_scroll = index.saturating_sub(visible_rows / 2);
let max_scroll = price_values.len().saturating_sub(visible_rows);
let new_scroll = target_scroll.min(max_scroll);
```

### 3. 价格精度聚合
- 支持配置的价格精度（默认0.01美元）
- 自动将交易价格聚合到配置的精度级别
- 确保窗口居中计算的准确性

## 配置参数

### 价格变化阈值
```rust
price_change_threshold: 0.1  // 价格变化0.1美元时触发重新居中
```

### 边界阈值
```rust
edge_threshold: 2  // 距离窗口边界2行时触发自动操作
```

### 价格精度
```rust
price_precision: 0.01  // 价格精度为0.01美元（1分）
```

## 使用场景

### 1. 实时交易监控
- 启用价格跟踪功能（按`t`键）
- 当前交易价格始终保持在屏幕中央
- 便于快速观察价格变化和订单簿深度

### 2. 手动价格定位
- 使用`r`键快速将窗口居中到当前交易价格
- 适用于价格快速变化时的手动调整

### 3. 传统滚动模式
- 关闭价格跟踪（按`t`键）
- 使用方向键手动控制窗口位置
- 适用于需要查看特定价格区间的场景

## 性能优化

### 1. 事件循环集成
- 价格跟踪逻辑集成在主事件循环中
- 每次事件循环都会检查价格变化
- 避免额外的线程开销

### 2. 计算优化
- 只在价格变化超过阈值时才重新计算
- 缓存上次跟踪的价格，避免重复计算
- 限制可见行数以提高性能

### 3. 内存效率
- 复用现有的价格列表和订单簿数据
- 避免创建额外的数据结构
- 最小化内存分配

## 故障排除

### 1. 价格跟踪不工作
- 检查是否有当前交易价格数据
- 确认WebSocket连接正常
- 查看日志中的调试信息

### 2. 窗口居中不准确
- 检查价格精度配置
- 确认订单簿数据完整性
- 调整价格变化阈值

### 3. 性能问题
- 减少最大可见行数
- 增加价格变化阈值
- 检查事件处理性能

## 日志调试

启用调试日志查看详细信息：
```bash
RUST_LOG=debug ./target/release/binance-futures BTCUSDT
```

关键日志信息：
- `价格跟踪: 当前价格 X.XX 触发窗口重新居中`
- `窗口居中: 目标价格 X.XX 位于索引 Y, 新滚动偏移 Z`
